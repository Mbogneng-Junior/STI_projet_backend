Project Context From: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend
Generated On: jeu. 18 d√©c. 2025 19:44:08 WAT
===============================================
Ignored Directory Patterns: .* node_modules vendor build dist target __pycache__ .next cache target storage
Ignored File Patterns: *.log *.jar *.pdf *.class *.sqlite project_context.txt package-lock.json yarn.lock composer.lock *.ico pnpm-lock.yaml
===============================================

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/config/adk_session.py

import os
from dotenv import load_dotenv # Import n√©cessaire
from google.adk.sessions import DatabaseSessionService

# 1. On force le chargement du .env situ√© √† la racine
# (On remonte d'un niveau par rapport √† 'config/')
base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
load_dotenv(os.path.join(base_dir, '.env'))

# 2. R√©cup√©ration des variables avec des valeurs par d√©faut pour le LOCAL
# Note: On force '127.0.0.1' si la variable est vide
DB_USER = os.environ.get('DB_USER', 'backendsti')
DB_PASSWORD = os.environ.get('DB_PASSWORD', 'backendsti')
DB_HOST = os.environ.get('DB_HOST', '127.0.0.1') 
DB_PORT = os.environ.get('DB_PORT', '5432')
DB_NAME = os.environ.get('DB_NAME', 'backendsti')

# 3. Construction de l'URL
# Important : asyncpg est requis pour l'async
db_url = f"postgresql+asyncpg://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_NAME}"

# Debug : Affiche l'URL (masque le mot de passe pour s√©curit√© si tu veux)
print(f"üîå ADK Connect to: postgresql+asyncpg://{DB_USER}:***@{DB_HOST}:{DB_PORT}/{DB_NAME}")

session_service = DatabaseSessionService(db_url=db_url)// END OF FILE: config/adk_session.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/config/asgi.py

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()
// END OF FILE: config/asgi.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/config/settings.py

"""
Django settings for config project.

Generated by 'django-admin startproject' using Django 4.2.3.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/4.2/ref/settings/
"""

import os
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/4.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-4#=x!8&@!7z!9@!8&@!7z!9@!8&@!7z!9@!8&@!7z!9@!8&@!7z!9@!8&@!7z!9'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['*']


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'drf_spectacular',
    'module_expert',
    'module_apprenant',
    'module_interface',
    'module_tuteur',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/4.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.environ.get('DB_NAME', 'backendsti'),
        'USER': os.environ.get('DB_USER', 'backendsti'),
        'PASSWORD': os.environ.get('DB_PASSWORD', 'backendsti'),
        'HOST': os.environ.get('DB_HOST', 'localhost'), # Default to localhost for local dev
        'PORT': os.environ.get('DB_PORT', '5432'),
    }
}




# Password validation
# https://docs.djangoproject.com/en/4.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/4.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/4.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/4.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'


# Ajoutez ce bloc √† la fin du fichier
REST_FRAMEWORK = {
    # Indique √† DRF d'utiliser drf-spectacular pour g√©n√©rer le sch√©ma de l'API
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
}

# (Optionnel mais recommand√©) Configuration de drf-spectacular
SPECTACULAR_SETTINGS = {
    'TITLE': 'API du Syst√®me Tuteur Intelligent M√©dical',
    'DESCRIPTION': "Documentation de l'API pour le projet de STI. Cette interface vous permet de tester tous les endpoints.",
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False, # Ne pas inclure le sch√©ma brut dans l'interface UI
    'ENUM_NAME_OVERRIDES': {
        'NiveauDifficulteEnum': 'module_expert.models.CasClinique.NiveauDifficult√©',
    },
}// END OF FILE: config/settings.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/config/urls.py

# config/urls.py

from django.contrib import admin
from django.urls import path, include
from drf_spectacular.views import SpectacularAPIView, SpectacularRedocView, SpectacularSwaggerView

urlpatterns = [
    # 1. Route pour l'interface d'administration de Django
    path('admin/', admin.site.urls),

    # 2. Routes pour la documentation de l'API (Swagger/OpenAPI)
    path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
    
    # Interface Swagger UI (pour tester)
    path('api/docs/', SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui'),
    
    # Interface Redoc (optionnel)
    path('api/redoc/', SpectacularRedocView.as_view(url_name='schema'), name='redoc'),


    # 3. Routes des modules de l'application
    path('api/v1/expert/', include('module_expert.urls')),
    path('api/v1/apprenant/', include('module_apprenant.urls')),
    path('api/v1/interface/', include('module_interface.urls')),
    
    # AJOUT : Route pour le Tuteur Intelligent (Chat & Logique P√©dagogique)
    path('api/v1/tuteur/', include('module_tuteur.urls')),
]// END OF FILE: config/urls.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/config/wsgi.py

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()
// END OF FILE: config/wsgi.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/db.sqlite3

// END OF FILE: db.sqlite3

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/deploy-radical.sh

#!/bin/bash
set -e # Sortir imm√©diatement si une commande √©choue

# --- CONFIGURATION ---
# Adresse IP publique de ton Droplet DigitalOcean
DROPLET_IP="104.236.244.230" 
# Utilisateur SSH (g√©n√©ralement root sur DigitalOcean)
SSH_USER="root"
# Chemin vers la racine de ton projet sur le Droplet
REMOTE_PROJECT_PATH="/STI_projet_backend"
# Nom de la branche Git √† d√©ployer
GIT_BRANCH="master" # Ou "main" si c'est ta branche principale
# Fichier docker-compose pour la production
DOCKER_COMPOSE_FILE="docker-compose.yml"

echo "=== D√©marrage du d√©ploiement sur le Droplet ${DROPLET_IP} ==="

# --- 1. V√©rification et Push Git (depuis la machine locale) ---
echo -e "\n--- 1. V√©rification et Push Git local ---"
# Assure-toi que toutes les modifications sont pouss√©es avant le d√©ploiement
git add .
git commit -m "D√©ploiement automatique: $(date)" || true # '|| true' pour ne pas √©chouer si pas de modifs
git push origin $GIT_BRANCH

echo "Code pouss√© sur ${GIT_BRANCH}. Connexion au Droplet..."

# --- 2. Connexion SSH et Ex√©cution des commandes √† distance ---
ssh ${SSH_USER}@${DROPLET_IP} << EOF
    set -e # Sortir imm√©diatement si une commande √©choue sur le serveur distant

    echo -e "\n--- 2.1. Navigation vers le r√©pertoire du projet (${REMOTE_PROJECT_PATH}) ---"
    cd ${REMOTE_PROJECT_PATH}

    echo -e "\n--- 2.2. R√©cup√©ration des derni√®res modifications depuis Git ---"
    # Ceci √©crase toute modification locale sur le serveur et synchronise avec le d√©p√¥t distant
    git pull

    echo -e "\n--- 2.3. Arr√™t et suppression des anciens conteneurs Docker ---"
    # Suppression des volumes anonymes pour nettoyer l'ancien √©tat si n√©cessaire (-v)
    docker compose -f ${DOCKER_COMPOSE_FILE} down -v || true # '|| true' car 'down' peut √©chouer si rien ne tourne

    echo -e "\n--- 2.4. Reconstruction et d√©marrage des conteneurs Docker (mode production) ---"
    # --build pour s'assurer que les derni√®res modifications du code et des requirements.txt sont prises en compte
    # -d pour lancer en arri√®re-plan
    docker compose -f ${DOCKER_COMPOSE_FILE} up --build -d

    echo -e "\n--- 2.5. Application des migrations de base de donn√©es ---"
    docker compose -f ${DOCKER_COMPOSE_FILE} exec web python manage.py migrate --noinput

    echo -e "\n--- 2.6. Collecte des fichiers statiques ---"
    # --noinput pour √©viter les questions de confirmation
    docker compose -f ${DOCKER_COMPOSE_FILE} exec web python manage.py collectstatic --noinput

    echo -e "\n--- D√©ploiement distant termin√© ! ---"
    echo "Votre application devrait √™tre accessible via http://${DROPLET_IP}/api/docs/"
    echo "Pour voir les logs : docker compose -f ${DOCKER_COMPOSE_FILE} logs -f"
EOF

echo -e "\n=== Script de d√©ploiement local termin√© ==="
echo "Acc√©dez √† l'application via http://${DROPLET_IP}/api/docs/"// END OF FILE: deploy-radical.sh

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/deploy.sh

#!/bin/bash
set -e # Sortir imm√©diatement si une commande √©choue

# --- CONFIGURATION ---
# Adresse IP publique de ton Droplet DigitalOcean
DROPLET_IP="104.236.244.230" 
# Utilisateur SSH (g√©n√©ralement root sur DigitalOcean)
SSH_USER="root"
# Chemin vers la racine de ton projet sur le Droplet
REMOTE_PROJECT_PATH="/STI_projet_backend"
# Nom de la branche Git √† d√©ployer
GIT_BRANCH="master" # Ou "main" si c'est ta branche principale
# Fichier docker-compose pour la production
DOCKER_COMPOSE_FILE="docker-compose.yml"

echo "=== D√©marrage du d√©ploiement sur le Droplet ${DROPLET_IP} ==="

# --- 1. V√©rification et Push Git (depuis la machine locale) ---
echo -e "\n--- 1. V√©rification et Push Git local ---"
# Assure-toi que toutes les modifications sont pouss√©es avant le d√©ploiement
git add .
git commit -m "D√©ploiement automatique: $(date)" || true # '|| true' pour ne pas √©chouer si pas de modifs
git push origin $GIT_BRANCH

echo "Code pouss√© sur ${GIT_BRANCH}. Connexion au Droplet..."

# --- 2. Connexion SSH et Ex√©cution des commandes √† distance ---
ssh ${SSH_USER}@${DROPLET_IP} << EOF
    set -e # Sortir imm√©diatement si une commande √©choue sur le serveur distant

    echo -e "\n--- 2.1. Navigation vers le r√©pertoire du projet (${REMOTE_PROJECT_PATH}) ---"
    cd ${REMOTE_PROJECT_PATH}

    echo -e "\n--- 2.2. R√©cup√©ration des derni√®res modifications depuis Git ---"
    # Ceci √©crase toute modification locale sur le serveur et synchronise avec le d√©p√¥t distant
    git pull

    echo -e "\n--- D√©ploiement distant termin√© ! ---"
    echo "Votre application devrait √™tre accessible via http://${DROPLET_IP}/api/docs/"
    echo "Pour voir les logs : docker compose -f ${DOCKER_COMPOSE_FILE} logs -f"
EOF

echo -e "\n=== Script de d√©ploiement local termin√© ==="
echo "Acc√©dez √† l'application via http://${DROPLET_IP}/api/docs/"// END OF FILE: deploy.sh

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/docker-compose.dev.yml

version: '3.9'

services:
  # On garde le service web configur√© au cas o√π, mais on ne le lancera pas
  web:
    build: .
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/app
    ports:
      - "8000:8000"
    env_file:
      - .env
    depends_on:
      - db

  db:
    image: postgres:15
    # --- AJOUT IMPORTANT ICI ---
    # Cela permet √† ton 'python manage.py runserver' local de parler au Docker
    ports:
      - "5432:5432"  
    # ---------------------------
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    env_file:
      - .env

volumes:
  postgres_data:// END OF FILE: docker-compose.dev.yml

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/docker-compose.red

version: '3.9'

services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: backendsti
      POSTGRES_USER: backendsti
      POSTGRES_PASSWORD: backendsti
    volumes:
      - postgres_data_v2:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  web:
    build: .
    command: sh -c "python wait_for_db.py && python manage.py migrate && python3 manage.py runserver 0.0.0.0:8000"
    volumes:
      - .:/app
    ports:
      - "8000:8000"
    depends_on:
      - db
    environment:
      - DJANGO_SUPERUSER_USERNAME=admin
      - DJANGO_SUPERUSER_PASSWORD=admin
      - DJANGO_SUPERUSER_EMAIL=admin@example.com
      - DB_NAME=backendsti
      - DB_USER=backendsti
      - DB_PASSWORD=backendsti
      - DB_HOST=db
      - DB_PORT=5432

volumes:
  postgres_data_v2:
// END OF FILE: docker-compose.red

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/docker-compose.yml

version: '3.9'

services:
  web:
    build: .
    # La commande a √©t√© simplifi√©e, migrate sera fait manuellement apr√®s le lancement
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - ./staticfiles:/app/staticfiles
    expose:
      - 8000
    env_file:
      - .env

  nginx:
    image: nginx:1.21-alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./staticfiles:/app/staticfiles
    depends_on:
      - web

volumes:
  staticfiles:// END OF FILE: docker-compose.yml

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/Dockerfile

FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

WORKDIR /app

COPY requirements.txt /app/
RUN pip install --upgrade pip && pip install -r requirements.txt

COPY . /app/

# Cr√©ation d'un utilisateur non-root pour la s√©curit√©
RUN adduser --disabled-password --no-create-home appuser
USER appuser

# Commande de lancement pour la production avec Gunicorn
CMD ["sh", "-c", "python wait_for_db.py && python manage.py migrate && gunicorn config.wsgi:application --bind 0.0.0.0:8000"]
// END OF FILE: Dockerfile

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/.env

# .env - Configuration pour D√âVELOPPEMENT LOCAL (Hybride)

SECRET_KEY=dev_secret_key_12345
DEBUG=True
ALLOWED_HOSTS=*

# --- Configuration de la base de donn√©es LOCALE (Docker) ---
# Doit correspondre √† ce qu'il y a dans docker-compose.dev.yml
DB_USER=backendsti
DB_PASSWORD=backendsti
DB_HOST=127.0.0.1 # Ou 'localhost' si vous pr√©f√©rez, mais '127.0.0.1' est plus explicite pour Docker expos√© localement
DB_PORT=5432
DB_NAME=backendsti

# D√âSACTIVER LE SSL EN LOCAL (Imp√©ratif)
DB_SSLMODE=disable

# --- Google AI ---
GOOGLE_GENAI_USE_VERTEXAI=FALSE
GOOGLE_API_KEY=AIzaSyD2MzLTRkr6PPH1WQMHFM7XGYrvb-yl_i8// END OF FILE: .env

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/.gitignore

.env
__pycache__/
*.pyc
db.sqlite3
.DS_Store
// END OF FILE: .gitignore

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/manage.py

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
// END OF FILE: manage.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/admin.py

from django.contrib import admin

# Register your models here.
// END OF FILE: module_apprenant/admin.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/apps.py

from django.apps import AppConfig


class ModuleApprenantConfig(AppConfig):
    name = 'module_apprenant'
// END OF FILE: module_apprenant/apps.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/__init__.py

// END OF FILE: module_apprenant/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/migrations/0001_initial.py

# Generated by Django 6.0 on 2025-12-10 15:25

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('module_expert', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Apprenant',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('nom', models.CharField(max_length=255)),
                ('email', models.EmailField(max_length=254, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Badge',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nom', models.CharField(max_length=255, unique=True)),
                ('description', models.TextField()),
            ],
        ),
        migrations.CreateModel(
            name='ProfilEtudiant',
            fields=[
                ('apprenant', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, primary_key=True, serialize=False, to='module_apprenant.apprenant')),
                ('xp_total', models.PositiveIntegerField(default=0)),
                ('lacunes_identifiees', models.TextField(blank=True)),
                ('badges', models.ManyToManyField(blank=True, to='module_apprenant.badge')),
            ],
        ),
        migrations.CreateModel(
            name='NiveauCompetence',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('niveau_actuel', models.CharField(choices=[('DEBUTANT', 'D√©butant'), ('INTERMEDIAIRE', 'Interm√©diaire'), ('AVANCE', 'Avanc√©'), ('EXPERT', 'Expert')], max_length=20)),
                ('score_diagnostic', models.FloatField(default=0.0)),
                ('score_raisonnement', models.FloatField(default=0.0)),
                ('domaine', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='niveaux_apprenants', to='module_expert.domainemedical')),
                ('profil_etudiant', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='competences', to='module_apprenant.profiletudiant')),
            ],
            options={
                'unique_together': {('profil_etudiant', 'domaine')},
            },
        ),
    ]
// END OF FILE: module_apprenant/migrations/0001_initial.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/migrations/__init__.py

// END OF FILE: module_apprenant/migrations/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/models.py

import uuid
from django.db import models
from module_expert.models import DomaineMedical # Importation inter-applications


# Create your models here.



class Apprenant(models.Model):
    id=models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    nom=models.CharField(max_length=255)
    email=models.EmailField(unique=True)

    def __str__(self):
        return self.email
    


class Badge(models.Model):

    nom=models.CharField(max_length=255, unique=True)

    description=models.TextField()
    def __str__(self):
        return  self.nom
    

class ProfilEtudiant(models.Model):
    apprenant=models.OneToOneField(Apprenant,on_delete=models.CASCADE,primary_key=True)
    xp_total = models.PositiveIntegerField(default=0)
    lacunes_identifiees = models.TextField(blank=True)
    badges = models.ManyToManyField(Badge, blank=True)

    def __str__(self):
        return f"Profil de {self.apprenant.email}"


class NiveauCompetence(models.Model):
    # On r√©utilise l'√©num√©ration de CasClinique pour la coh√©rence
    from module_expert.models import CasClinique
    
    profil_etudiant = models.ForeignKey(
        ProfilEtudiant, 
        on_delete=models.CASCADE, 
        related_name="competences"
    )
    domaine = models.ForeignKey(
        DomaineMedical, 
        on_delete=models.PROTECT, 
        related_name="niveaux_apprenants"
    )
    niveau_actuel = models.CharField(
        max_length=20, 
        choices=CasClinique.NiveauDifficult√©.choices
    )
    score_diagnostic = models.FloatField(default=0.0)
    score_raisonnement = models.FloatField(default=0.0)

    class Meta:
        unique_together = ('profil_etudiant', 'domaine')

    def __str__(self):
        return f"{self.profil_etudiant.apprenant.email} - {self.domaine.nom}"// END OF FILE: module_apprenant/models.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/serializers.py

from rest_framework import serializers
from .models import Apprenant, Badge, ProfilEtudiant, NiveauCompetence

class ApprenantSerializer(serializers.ModelSerializer):
    class Meta:
        model = Apprenant
        fields = '__all__'

class BadgeSerializer(serializers.ModelSerializer):
    class Meta:
        model = Badge
        fields = '__all__'

class ProfilEtudiantSerializer(serializers.ModelSerializer):
    badges = BadgeSerializer(many=True, read_only=True)
    
    class Meta:
        model = ProfilEtudiant
        fields = '__all__'

class NiveauCompetenceSerializer(serializers.ModelSerializer):
    class Meta:
        model = NiveauCompetence
        fields = '__all__'
// END OF FILE: module_apprenant/serializers.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/tests.py

from django.test import TestCase

# Create your tests here.
// END OF FILE: module_apprenant/tests.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/urls.py

from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import (
    ApprenantViewSet, 
    BadgeViewSet, 
    ProfilEtudiantViewSet, 
    NiveauCompetenceViewSet
)

router = DefaultRouter()
router.register(r'apprenants', ApprenantViewSet)
router.register(r'badges', BadgeViewSet)
router.register(r'profils', ProfilEtudiantViewSet)
router.register(r'niveaux-competence', NiveauCompetenceViewSet)

urlpatterns = [
    path('', include(router.urls)),
]
// END OF FILE: module_apprenant/urls.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_apprenant/views.py

from rest_framework import viewsets
from drf_spectacular.utils import extend_schema
from .models import Apprenant, Badge, ProfilEtudiant, NiveauCompetence
from .serializers import (
    ApprenantSerializer, 
    BadgeSerializer, 
    ProfilEtudiantSerializer, 
    NiveauCompetenceSerializer
)

@extend_schema(tags=['Apprenant - Comptes'])
class ApprenantViewSet(viewsets.ModelViewSet):
    queryset = Apprenant.objects.all()
    serializer_class = ApprenantSerializer

@extend_schema(tags=['Apprenant - Badges'])
class BadgeViewSet(viewsets.ModelViewSet):
    queryset = Badge.objects.all()
    serializer_class = BadgeSerializer

@extend_schema(tags=['Apprenant - Profils'])
class ProfilEtudiantViewSet(viewsets.ModelViewSet):
    queryset = ProfilEtudiant.objects.all()
    serializer_class = ProfilEtudiantSerializer

@extend_schema(tags=['Apprenant - Comp√©tences'])
class NiveauCompetenceViewSet(viewsets.ModelViewSet):
    queryset = NiveauCompetence.objects.all()
    serializer_class = NiveauCompetenceSerializer
// END OF FILE: module_apprenant/views.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/admin.py

from django.contrib import admin

# Register your models here.
// END OF FILE: module_expert/admin.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/agent.py



import json
from google.adk.agents import Agent

from module_expert.constante import MODEL_NAME
from .tools.domain_tools import list_available_domains

from google.adk.apps.app import App
from google.adk.agents.context_cache_config import ContextCacheConfig
from .subagents import (
    malaria_expert,
    cardiologie_expert,
    pediatrie_expert,
    dermatologie_expert
)

import os
import sys
import django

from .tools.domain_tools import list_available_domains


from dotenv import load_dotenv

# --- BLOC D'INITIALISATION DJANGO (OBLIGATOIRE POUR ADK WEB) ---

# 1. Charger les variables d'environnement (.env √† la racine)
# Cela permet √† Django de trouver DB_USER, DB_PASSWORD, etc.
current_dir = os.path.dirname(os.path.abspath(__file__))
base_dir = os.path.dirname(current_dir) # Remonte vers /backend
load_dotenv(os.path.join(base_dir, '.env'))

# 2. Ajouter la racine du projet au Python Path
sys.path.append(base_dir)

# 3. Configurer les settings Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

# 4. D√©marrer Django
# C'est cette ligne qui permet ensuite d'importer les mod√®les
django.setup()

# --- FIN DU BLOC D'INITIALISATION ---

# --- AGENT RACINE ---

root_expert_instruction = (
    "Tu es l'Agent Expert Racine du syst√®me de Tuteur Intelligent.\n"
    "Ton r√¥le est d'orchestrer l'expertise m√©dicale.\n\n"
    
    "### FONCTIONNEMENT ###\n"
    "1. Tu re√ßois une demande concernant un cas clinique.\n"
    "2. Tu dois identifier le DOMAINE M√âDICAL concern√© (ex: Paludisme, Cardiologie, etc.).\n"
    "3. Tu dois d√©l√©guer l'analyse au sous-agent expert de ce domaine.\n"
    "   - Si le cas concerne le Paludisme, d√©l√®gue √† 'Expert_Paludisme'.\n"
    "   - Si le cas concerne la Cardiologie, d√©l√®gue √† 'Expert_Cardiologie'.\n"
    "   - Si le cas concerne la P√©diatrie, d√©l√®gue √† 'Expert_Pediatrie'.\n"
    "   - Si le cas concerne la Dermatologie, d√©l√®gue √† 'Expert_Dermatologie'.\n"
    "   - Si aucun expert sp√©cifique n'est disponible, signale-le.\n\n"
    
    "Tu ne dois pas inventer de diagnostic toi-m√™me si tu n'as pas les r√®gles sp√©cifiques. "
    "Ton intelligence r√©side dans ta capacit√© √† router la demande vers le bon sp√©cialiste."
)

root_agent = Agent(
    name="Root_Expert_Medical",
    
    model=MODEL_NAME,
    description="Orchestrateur expert m√©dical.",
    instruction=root_expert_instruction,
    tools=[list_available_domains],
    sub_agents=[
        malaria_expert,
        cardiologie_expert,
        pediatrie_expert,
        dermatologie_expert
    ]
)


expert_app = App(
    # CORRECTION ICI : remplace les tirets par des underscores
    name='sti_expert_medical_app', 
    
    root_agent=root_agent,
    context_cache_config=ContextCacheConfig(
        min_tokens=1000,
        ttl_seconds=3600,
        cache_intervals=10,
    ),
)

# Note: La factory 'create_expert_agent' a √©t√© remplac√©e par l'architecture multi-agents statique/dynamique
# d√©finie dans le dossier 'subagents'.
// END OF FILE: module_expert/agent.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/apps.py

from django.apps import AppConfig


class ModuleExpertConfig(AppConfig):
    name = 'module_expert'
// END OF FILE: module_expert/apps.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/constante.py

# module_expert/constante.py
MODEL_NAME = "gemini-2.5-flash-lite"  # Remplacez par le nom r√©el du mod√®le
// END OF FILE: module_expert/constante.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/__init__.py

// END OF FILE: module_expert/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/migrations/0001_initial.py

# Generated by Django 6.0 on 2025-12-10 15:25

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='DomaineMedical',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('nom', models.CharField(max_length=255, unique=True)),
                ('description', models.TextField(blank=True)),
            ],
        ),
        migrations.CreateModel(
            name='CasClinique',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('titre', models.CharField(max_length=255)),
                ('statut', models.CharField(choices=[('BROUILLON_IA', 'Brouillon (IA)'), ('EN_REVISION', 'En R√©vision'), ('PUBLIE', 'Publi√©'), ('REJETE', 'Rejet√©'), ('ARCHIVE', 'Archiv√©')], default='BROUILLON_IA', max_length=20)),
                ('difficulte', models.CharField(choices=[('DEBUTANT', 'D√©butant'), ('INTERMEDIAIRE', 'Interm√©diaire'), ('AVANCE', 'Avanc√©'), ('EXPERT', 'Expert')], max_length=20)),
                ('donnees_patient', models.JSONField()),
                ('historique_medical', models.TextField()),
                ('solution_experte', models.TextField()),
                ('date_validation', models.DateTimeField(blank=True, null=True)),
                ('source_fultang_id', models.CharField(blank=True, db_index=True, max_length=255, null=True)),
                ('domaine', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='cas_cliniques', to='module_expert.domainemedical')),
            ],
        ),
        migrations.CreateModel(
            name='ExpertHumain',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('nom', models.CharField(max_length=255)),
                ('matricule', models.CharField(max_length=100, unique=True)),
                ('domaine_expertise', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='experts_humains', to='module_expert.domainemedical')),
            ],
        ),
        migrations.CreateModel(
            name='ExpertIA',
            fields=[
                ('id', models.CharField(max_length=255, primary_key=True, serialize=False)),
                ('nom_ia', models.CharField(max_length=255)),
                ('base_connaissance', models.TextField(blank=True)),
                ('domaine_specialisation', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='experts_ia', to='module_expert.domainemedical')),
            ],
        ),
        migrations.CreateModel(
            name='EtapeClinique',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('ordre', models.PositiveIntegerField()),
                ('description', models.TextField()),
                ('type_etape', models.CharField(blank=True, max_length=100)),
                ('cas_clinique', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='etapes', to='module_expert.casclinique')),
            ],
            options={
                'ordering': ['ordre'],
                'unique_together': {('cas_clinique', 'ordre')},
            },
        ),
    ]
// END OF FILE: module_expert/migrations/0001_initial.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/migrations/__init__.py

// END OF FILE: module_expert/migrations/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/models.py

# module_expert/models.py

import uuid
from django.db import models

class DomaineMedical(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    nom = models.CharField(max_length=255, unique=True)
    description = models.TextField(blank=True)

    def __str__(self):
        return self.nom

class ExpertHumain(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    nom = models.CharField(max_length=255)
    matricule = models.CharField(max_length=100, unique=True)
    domaine_expertise = models.ForeignKey(
        DomaineMedical, 
        on_delete=models.PROTECT, 
        related_name="experts_humains"
    )

    def __str__(self):
        return f"{self.nom} ({self.domaine_expertise.nom})"

class ExpertIA(models.Model):
    id = models.CharField(max_length=255, primary_key=True)
    nom_ia = models.CharField(max_length=255)
    base_connaissance = models.TextField(blank=True)
    domaine_specialisation = models.ForeignKey(
        DomaineMedical, 
        on_delete=models.PROTECT, 
        related_name="experts_ia"
    )

    def __str__(self):
        return self.nom_ia

class CasClinique(models.Model):
    class StatutCas(models.TextChoices):
        BROUILLON_IA = 'BROUILLON_IA', 'Brouillon (IA)'
        EN_REVISION = 'EN_REVISION', 'En R√©vision'
        PUBLIE = 'PUBLIE', 'Publi√©'
        REJETE = 'REJETE', 'Rejet√©'
        ARCHIVE = 'ARCHIVE', 'Archiv√©'

    class NiveauDifficult√©(models.TextChoices):
        DEBUTANT = 'DEBUTANT', 'D√©butant'
        INTERMEDIAIRE = 'INTERMEDIAIRE', 'Interm√©diaire'
        AVANCE = 'AVANCE', 'Avanc√©'
        EXPERT = 'EXPERT', 'Expert'

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    titre = models.CharField(max_length=255)
    statut = models.CharField(max_length=20, choices=StatutCas.choices, default=StatutCas.BROUILLON_IA)
    difficulte = models.CharField(max_length=20, choices=NiveauDifficult√©.choices)
    donnees_patient = models.JSONField()
    historique_medical = models.TextField()
    solution_experte = models.TextField()
    date_validation = models.DateTimeField(blank=True, null=True)
    source_fultang_id = models.CharField(max_length=255, blank=True, null=True, db_index=True)
    domaine = models.ForeignKey(
        DomaineMedical, 
        on_delete=models.PROTECT, 
        related_name="cas_cliniques"
    )

    def __str__(self):
        return self.titre

class EtapeClinique(models.Model):
    cas_clinique = models.ForeignKey(
        CasClinique, 
        on_delete=models.CASCADE, 
        related_name="etapes"
    )
    ordre = models.PositiveIntegerField()
    description = models.TextField()
    type_etape = models.CharField(max_length=100, blank=True)

    class Meta:
        ordering = ['ordre']
        unique_together = ('cas_clinique', 'ordre')

    def __str__(self):
        return f"√âtape {self.ordre} de {self.cas_clinique.titre}"// END OF FILE: module_expert/models.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/serializers.py

from rest_framework import serializers
from .models import DomaineMedical, ExpertHumain, ExpertIA, CasClinique, EtapeClinique

class DomaineMedicalSerializer(serializers.ModelSerializer):
    class Meta:
        model = DomaineMedical
        fields = '__all__'

class ExpertHumainSerializer(serializers.ModelSerializer):
    class Meta:
        model = ExpertHumain
        fields = '__all__'

class ExpertIASerializer(serializers.ModelSerializer):
    class Meta:
        model = ExpertIA
        fields = '__all__'

class EtapeCliniqueSerializer(serializers.ModelSerializer):
    class Meta:
        model = EtapeClinique
        fields = '__all__'

class CasCliniqueSerializer(serializers.ModelSerializer):
    etapes = EtapeCliniqueSerializer(many=True, read_only=True)
    
    class Meta:
        model = CasClinique
        fields = '__all__'
// END OF FILE: module_expert/serializers.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/cardiologie/agent.py

from google.adk.agents import Agent
from .tools.expert_tools import search_cardio_cases
from module_expert.constante import MODEL_NAME

cardiologie_expert = Agent(
    name="Expert_Cardiologie",
    model=MODEL_NAME,
    description="Expert m√©dical sp√©cialis√© dans les maladies cardiaques et vasculaires.",
    instruction=(
        "Tu es un expert en Cardiologie.\n"
        "Ton r√¥le est d'analyser les cas cliniques li√©s au c≈ìur (douleurs thoraciques, hypertension, etc.).\n"
        "Utilise l'outil 'search_cardio_cases' pour valider tes hypoth√®ses avec la base de connaissances.\n"
        "Sois vigilant sur les signes d'urgence vitale."
    ),
    tools=[search_cardio_cases]
)
// END OF FILE: module_expert/subagents/cardiologie/agent.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/cardiologie/__init__.py

from .agent import cardiologie_expert// END OF FILE: module_expert/subagents/cardiologie/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/cardiologie/tools/expert_tools.py

import json
from google.adk.tools import FunctionTool
from google.adk.tools import ToolContext # NOUVEL IMPORT : pour le contexte de l'outil
from asgiref.sync import sync_to_async # NOUVEL IMPORT : pour appeler le code synchrone depuis l'async

# Importation diff√©r√©e de models √† l'int√©rieur de la fonction pour assurer l'initialisation de Django
# from module_expert.models import CasClinique # Retire cet import global

async def search_cardio_cases_fn(symptoms: str, tool_context: ToolContext) -> str:
    """
    Recherche des cas cliniques similaires dans la base de connaissances
    pour le domaine de la Cardiologie.
    
    Args:
        symptoms: Une description textuelle des sympt√¥mes observ√©s.
        tool_context: Le contexte de l'outil fourni par l'ADK.
        
    Returns:
        Une cha√Æne JSON contenant les cas similaires trouv√©s.
    """
    # Importation locale pour garantir que Django est configur√© au moment de l'appel de la fonction.
    from module_expert.models import CasClinique
    
    try:
        domaine_nom = "Cardiologie" 
        
        # Appel asynchrone √† l'ORM Django (qui est synchrone par nature)
        # On utilise sync_to_async pour ne pas bloquer la boucle d'√©v√©nements de l'ADK.
        cas_similaires = await sync_to_async(CasClinique.objects.filter)(
            domaine__nom__iexact=domaine_nom,
            statut=CasClinique.StatutCas.PUBLIE
        )[:3]
        
        results = []
        for cas in cas_similaires:
            results.append({
                "titre": cas.titre,
                "contexte": cas.donnees_patient,
                "diagnostic_expert": cas.solution_experte,
                "explication": cas.historique_medical
            })
            
        if not results:
            return "Aucun cas similaire trouv√© en Cardiologie."
            
        return json.dumps(results, ensure_ascii=False, indent=2)

    except Exception as e:
        return f"Erreur lors de la recherche en Cardiologie: {str(e)}"

# Le FunctionTool doit √™tre marqu√© comme asynchrone (is_async=True)
search_cardio_cases = FunctionTool(func=search_cardio_cases_fn)// END OF FILE: module_expert/subagents/cardiologie/tools/expert_tools.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/cardiologie/tools/knowledge.json

[
  {
    "rule_id": "cardio_rule_001",
    "symptoms": ["douleur thoracique", "irradiation bras gauche", "sueurs froides"],
    "diagnosis": "Infarctus du myocarde",
    "treatment": "Aspirine, Appel urgence, Thrombolyse"
  }
]// END OF FILE: module_expert/subagents/cardiologie/tools/knowledge.json

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/dermatologie/agent.py

from google.adk.agents import Agent
from .tools.expert_tools import search_derma_cases
from module_expert.constante import MODEL_NAME

dermatologie_expert = Agent(
    name="Expert_Dermatologie",
    model=MODEL_NAME,
    description="Expert m√©dical sp√©cialis√© dans les maladies de la peau.",
    instruction=(
        "Tu es un expert en Dermatologie.\n"
        "Ton r√¥le est d'analyser les affections cutan√©es.\n"
        "Utilise l'outil 'search_derma_cases' pour comparer les sympt√¥mes visuels ou d√©crits avec ta base.\n"
        "Sois pr√©cis sur la description des l√©sions."
    ),
    tools=[search_derma_cases]
)
// END OF FILE: module_expert/subagents/dermatologie/agent.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/dermatologie/__init__.py

from .agent import dermatologie_expert// END OF FILE: module_expert/subagents/dermatologie/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/dermatologie/tools/expert_tools.py

import json
from google.adk.tools import FunctionTool
from google.adk.tools import ToolContext # NOUVEL IMPORT
from asgiref.sync import sync_to_async # NOUVEL IMPORT

# Importation diff√©r√©e de models √† l'int√©rieur de la fonction
# from module_expert.models import CasClinique # Retire cet import global

async def search_derma_cases_fn(symptoms: str, tool_context: ToolContext) -> str:
    """
    Recherche des cas cliniques similaires dans la base de connaissances
    pour le domaine de la Dermatologie.
    
    Args:
        symptoms: Une description textuelle des sympt√¥mes observ√©s.
        tool_context: Le contexte de l'outil fourni par l'ADK.
        
    Returns:
        Une cha√Æne JSON contenant les cas similaires trouv√©s.
    """
    # Importation locale pour garantir que Django est configur√© au moment de l'appel de la fonction.
    from module_expert.models import CasClinique
    
    try:
        domaine_nom = "Dermatologie" 
        
        cas_similaires = await sync_to_async(CasClinique.objects.filter)(
            domaine__nom__iexact=domaine_nom,
            statut=CasClinique.StatutCas.PUBLIE
        )[:3]
        
        results = []
        for cas in cas_similaires:
            results.append({
                "titre": cas.titre,
                "contexte": cas.donnees_patient,
                "diagnostic_expert": cas.solution_experte,
                "explication": cas.historique_medical
            })
            
        if not results:
            return "Aucun cas similaire trouv√© en Dermatologie."
            
        return json.dumps(results, ensure_ascii=False, indent=2)

    except Exception as e:
        return f"Erreur lors de la recherche en Dermatologie: {str(e)}"

search_derma_cases = FunctionTool(func=search_derma_cases_fn)// END OF FILE: module_expert/subagents/dermatologie/tools/expert_tools.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/dermatologie/tools/knowledge.json

[
  {
    "rule_id": "derma_rule_001",
    "symptoms": ["plaques rouges", "d√©mangeaisons intenses", "s√©cheresse cutan√©e"],
    "diagnosis": "Ecz√©ma atopique",
    "treatment": "Cr√®mes hydratantes, Cortico√Ødes locaux"
  }
]// END OF FILE: module_expert/subagents/dermatologie/tools/knowledge.json

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/__init__.py

from .malaria import malaria_expert
from .cardiologie import cardiologie_expert
from .pediatrie import pediatrie_expert
from .dermatologie import dermatologie_expert
// END OF FILE: module_expert/subagents/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/malaria/agent.py

from google.adk.agents import Agent
from .tools.expert_tools import search_similar_cases
from module_expert.constante import MODEL_NAME

# D√©finition de l'agent expert en Paludisme
malaria_expert = Agent(
    name="Expert_Paludisme",
    model=MODEL_NAME,
    description="Expert m√©dical sp√©cialis√© dans le diagnostic et le traitement du Paludisme.",
    instruction=(
        "Tu es un expert m√©dical sp√©cialis√© dans le Paludisme.\n"
        "Ton r√¥le est d'analyser les cas suspects de paludisme et de valider les diagnostics.\n"
        "Utilise l'outil 'search_similar_cases' pour consulter ta base de connaissances (r√®gles de production) "
        "et comparer le cas actuel avec des cas valid√©s.\n"
        "Base tes explications UNIQUEMENT sur les preuves m√©dicales et les cas similaires trouv√©s."
    ),
    tools=[search_similar_cases]
)
// END OF FILE: module_expert/subagents/malaria/agent.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/malaria/__init__.py

from .agent import malaria_expert// END OF FILE: module_expert/subagents/malaria/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/malaria/tools/expert_tools.py

import json
from google.adk.tools import FunctionTool
from google.adk.tools import ToolContext # NOUVEL IMPORT
from asgiref.sync import sync_to_async # NOUVEL IMPORT

# Importation diff√©r√©e de models √† l'int√©rieur de la fonction
# from module_expert.models import CasClinique, DomaineMedical # Retire cet import global

async def search_similar_cases_fn(symptoms: str, tool_context: ToolContext) -> str:
    """
    Recherche des cas cliniques similaires (r√®gles de production) dans la base de connaissances
    pour le domaine du Paludisme, bas√©s sur les sympt√¥mes fournis.
    
    Args:
        symptoms: Une description textuelle des sympt√¥mes observ√©s.
        tool_context: Le contexte de l'outil fourni par l'ADK.
        
    Returns:
        Une cha√Æne JSON contenant les cas similaires trouv√©s (Diagnostic, Traitement, Explication).
    """
    # Importation locale pour garantir que Django est configur√© au moment de l'appel de la fonction.
    from module_expert.models import CasClinique, DomaineMedical
    
    try:
        domaine_nom = "Paludisme" 
        
        cas_similaires = await sync_to_async(CasClinique.objects.filter)(
            domaine__nom__iexact=domaine_nom,
            statut=CasClinique.StatutCas.PUBLIE
        )[:3]
        
        results = []
        for cas in cas_similaires:
            results.append({
                "titre": cas.titre,
                "contexte": cas.donnees_patient,
                "diagnostic_expert": cas.solution_experte,
                "explication": cas.historique_medical
            })
            
        if not results:
            return "Aucun cas similaire trouv√© dans la base de connaissances pour ces sympt√¥mes."
            
        return json.dumps(results, ensure_ascii=False, indent=2)

    except Exception as e:
        return f"Erreur lors de la recherche dans la base de connaissances: {str(e)}"

search_similar_cases = FunctionTool(func=search_similar_cases_fn)// END OF FILE: module_expert/subagents/malaria/tools/expert_tools.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/malaria/tools/knowledge.json

[
  {
    "rule_id": "example_rule_001",
    "symptoms": ["fi√®vre", "frissons", "maux de t√™te"],
    "diagnosis": "Paludisme simple",
    "treatment": "Artemether-Lumefantrine"
  }
]// END OF FILE: module_expert/subagents/malaria/tools/knowledge.json

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/pediatrie/agent.py

from google.adk.agents import Agent
from .tools.expert_tools import search_pedia_cases
from module_expert.constante import MODEL_NAME

pediatrie_expert = Agent(
    name="Expert_Pediatrie",
    model=MODEL_NAME,
    description="Expert m√©dical sp√©cialis√© dans la sant√© des enfants et nourrissons.",
    instruction=(
        "Tu es un expert en P√©diatrie.\n"
        "Ton r√¥le est d'analyser les cas cliniques concernant des enfants.\n"
        "Utilise l'outil 'search_pedia_cases' pour valider tes diagnostics.\n"
        "Adapte tes explications aux sp√©cificit√©s physiologiques de l'enfant."
    ),
    tools=[search_pedia_cases]
)
// END OF FILE: module_expert/subagents/pediatrie/agent.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/pediatrie/__init__.py

from .agent import pediatrie_expert// END OF FILE: module_expert/subagents/pediatrie/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/pediatrie/tools/expert_tools.py

import json
from google.adk.tools import FunctionTool
from google.adk.tools import ToolContext # NOUVEL IMPORT
from asgiref.sync import sync_to_async # NOUVEL IMPORT

# Importation diff√©r√©e de models √† l'int√©rieur de la fonction
# from module_expert.models import CasClinique # Retire cet import global

async def search_pedia_cases_fn(symptoms: str, tool_context: ToolContext) -> str:
    """
    Recherche des cas cliniques similaires dans la base de connaissances
    pour le domaine de la P√©diatrie.
    
    Args:
        symptoms: Une description textuelle des sympt√¥mes observ√©s.
        tool_context: Le contexte de l'outil fourni par l'ADK.
        
    Returns:
        Une cha√Æne JSON contenant les cas similaires trouv√©s.
    """
    # Importation locale pour garantir que Django est configur√© au moment de l'appel de la fonction.
    from module_expert.models import CasClinique
    
    try:
        domaine_nom = "P√©diatrie" 
        
        cas_similaires = await sync_to_async(CasClinique.objects.filter)(
            domaine__nom__iexact=domaine_nom,
            statut=CasClinique.StatutCas.PUBLIE
        )[:3]
        
        results = []
        for cas in cas_similaires:
            results.append({
                "titre": cas.titre,
                "contexte": cas.donnees_patient,
                "diagnostic_expert": cas.solution_experte,
                "explication": cas.historique_medical
            })
            
        if not results:
            return "Aucun cas similaire trouv√© en P√©diatrie."
            
        return json.dumps(results, ensure_ascii=False, indent=2)

    except Exception as e:
        return f"Erreur lors de la recherche en P√©diatrie: {str(e)}"

search_pedia_cases = FunctionTool(func=search_pedia_cases_fn)// END OF FILE: module_expert/subagents/pediatrie/tools/expert_tools.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/subagents/pediatrie/tools/knowledge.json

[
  {
    "rule_id": "pedia_rule_001",
    "symptoms": ["fi√®vre > 39¬∞C", "toux", "nez qui coule", "yeux rouges"],
    "diagnosis": "Rougeole",
    "treatment": "Repos, Hydratation, Antipyr√©tiques, Vitamine A"
  }
]// END OF FILE: module_expert/subagents/pediatrie/tools/knowledge.json

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/tests.py

from django.test import TestCase

# Create your tests here.
// END OF FILE: module_expert/tests.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/tools/domain_tools.py

from google.adk.tools import FunctionTool

def list_available_domains_fn() -> str:
    """
    Liste tous les domaines m√©dicaux disponibles dans le syst√®me pour lesquels un expert existe.
    
    Returns:
        Une liste des noms de domaines (ex: "Paludisme", "Cardiologie").
    """
    from module_expert.models import DomaineMedical
    try:
        domaines = DomaineMedical.objects.values_list('nom', flat=True)
        return list(domaines)
    except Exception:
        return []

list_available_domains = FunctionTool(func=list_available_domains_fn)
// END OF FILE: module_expert/tools/domain_tools.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/urls.py

from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import (
    DomaineMedicalViewSet, 
    ExpertHumainViewSet, 
    ExpertIAViewSet, 
    CasCliniqueViewSet, 
    EtapeCliniqueViewSet
)

router = DefaultRouter()
router.register(r'domaines', DomaineMedicalViewSet)
router.register(r'experts-humains', ExpertHumainViewSet)
router.register(r'experts-ia', ExpertIAViewSet)
router.register(r'cas-cliniques', CasCliniqueViewSet)
router.register(r'etapes-cliniques', EtapeCliniqueViewSet)

urlpatterns = [
    path('', include(router.urls)),
]
// END OF FILE: module_expert/urls.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_expert/views.py

from rest_framework import viewsets
from drf_spectacular.utils import extend_schema
from .models import DomaineMedical, ExpertHumain, ExpertIA, CasClinique, EtapeClinique
from .serializers import (
    DomaineMedicalSerializer, 
    ExpertHumainSerializer, 
    ExpertIASerializer, 
    CasCliniqueSerializer, 
    EtapeCliniqueSerializer
)

@extend_schema(tags=['Expert - Domaines M√©dicaux'])
class DomaineMedicalViewSet(viewsets.ModelViewSet):
    queryset = DomaineMedical.objects.all()
    serializer_class = DomaineMedicalSerializer

@extend_schema(tags=['Expert - Experts Humains'])
class ExpertHumainViewSet(viewsets.ModelViewSet):
    queryset = ExpertHumain.objects.all()
    serializer_class = ExpertHumainSerializer

@extend_schema(tags=['Expert - Experts IA'])
class ExpertIAViewSet(viewsets.ModelViewSet):
    queryset = ExpertIA.objects.all()
    serializer_class = ExpertIASerializer

@extend_schema(tags=['Expert - Cas Cliniques'])
class CasCliniqueViewSet(viewsets.ModelViewSet):
    queryset = CasClinique.objects.all()
    serializer_class = CasCliniqueSerializer

@extend_schema(tags=['Expert - √âtapes Cliniques'])
class EtapeCliniqueViewSet(viewsets.ModelViewSet):
    queryset = EtapeClinique.objects.all()
    serializer_class = EtapeCliniqueSerializer
// END OF FILE: module_expert/views.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/admin.py

from django.contrib import admin

# Register your models here.
// END OF FILE: module_interface/admin.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/apps.py

from django.apps import AppConfig


class ModuleInterfaceConfig(AppConfig):
    name = 'module_interface'
// END OF FILE: module_interface/apps.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/__init__.py

// END OF FILE: module_interface/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/migrations/0001_initial.py

# Generated by Django 6.0 on 2025-12-10 15:25

import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('module_apprenant', '0001_initial'),
        ('module_expert', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='SessionApprentissage',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('date_debut', models.DateTimeField(auto_now_add=True)),
                ('date_fin', models.DateTimeField(blank=True, null=True)),
                ('score_session', models.IntegerField(default=0, null=True)),
                ('apprenant', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='sessions', to='module_apprenant.apprenant')),
                ('cas_clinique', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='sessions', to='module_expert.casclinique')),
            ],
        ),
        migrations.CreateModel(
            name='Interaction',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('question_contenu', models.TextField()),
                ('reponse_contenu', models.TextField(blank=True)),
                ('reponse_est_valide', models.BooleanField(null=True)),
                ('feedback_contenu', models.TextField(blank=True)),
                ('feedback_type', models.CharField(blank=True, choices=[('DIRECT', 'Direct'), ('SOCRATIQUE', 'Socratique'), ('SCAFFOLDING', 'Scaffolding')], max_length=20)),
                ('session', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='interactions', to='module_interface.sessionapprentissage')),
            ],
            options={
                'ordering': ['timestamp'],
            },
        ),
    ]
// END OF FILE: module_interface/migrations/0001_initial.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/migrations/__init__.py

// END OF FILE: module_interface/migrations/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/models_persistence.py

from django.db import models
from django.contrib.auth import get_user_model

User = get_user_model()

class PersistentSession(models.Model):
    id = models.CharField(primary_key=True, max_length=100)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    app_name = models.CharField(max_length=100)
    state = models.JSONField(default=dict)
    last_update = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"Session {self.id} ({self.user})"

class SessionEvent(models.Model):
    session = models.ForeignKey(PersistentSession, on_delete=models.CASCADE, related_name='events')
    author = models.CharField(max_length=100)
    content = models.TextField()
    timestamp = models.DateTimeField(auto_now_add=True)
    state_delta = models.JSONField(default=dict)

    def __str__(self):
        return f"Event {self.id} in Session {self.session_id}"

class SessionMemory(models.Model):
    session = models.ForeignKey(PersistentSession, on_delete=models.CASCADE, related_name='memories')
    key = models.CharField(max_length=255)
    value = models.JSONField()
    scope = models.CharField(max_length=20, choices=[('session', 'Session'), ('user', 'User'), ('app', 'App')], default='session')
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"Memory {self.key} (scope: {self.scope})"
// END OF FILE: module_interface/models_persistence.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/models.py

# module_interface/models.py

import uuid
from django.db import models
from module_apprenant.models import Apprenant
from module_expert.models import CasClinique

class SessionApprentissage(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    apprenant = models.ForeignKey(
        Apprenant, 
        on_delete=models.CASCADE, 
        related_name="sessions"
    )
    cas_clinique = models.ForeignKey(
        CasClinique, 
        on_delete=models.SET_NULL, # On garde la session m√™me si le cas est supprim√©
        null=True, 
        related_name="sessions"
    )
    date_debut = models.DateTimeField(auto_now_add=True)
    date_fin = models.DateTimeField(blank=True, null=True)
    score_session = models.IntegerField(default=0, null=True)

    def __str__(self):
        return f"Session de {self.apprenant.email} sur '{self.cas_clinique.titre}'"

class Interaction(models.Model):
    class TypeFeedback(models.TextChoices):
        DIRECT = 'DIRECT', 'Direct'
        SOCRATIQUE = 'SOCRATIQUE', 'Socratique'
        SCAFFOLDING = 'SCAFFOLDING', 'Scaffolding'

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    session = models.ForeignKey(
        SessionApprentissage, 
        on_delete=models.CASCADE, 
        related_name="interactions"
    )
    timestamp = models.DateTimeField(auto_now_add=True)
    
    question_contenu = models.TextField()
    reponse_contenu = models.TextField(blank=True)
    reponse_est_valide = models.BooleanField(null=True)
    feedback_contenu = models.TextField(blank=True)
    feedback_type = models.CharField(max_length=20, choices=TypeFeedback.choices, blank=True)
    
    class Meta:
        ordering = ['timestamp']

    def __str__(self):
        return f"Interaction du {self.timestamp.strftime('%Y-%m-%d %H:%M')}"// END OF FILE: module_interface/models.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/serializers.py

from rest_framework import serializers
from .models import SessionApprentissage, Interaction

class InteractionSerializer(serializers.ModelSerializer):
    class Meta:
        model = Interaction
        fields = '__all__'

class SessionApprentissageSerializer(serializers.ModelSerializer):
    interactions = InteractionSerializer(many=True, read_only=True)
    
    class Meta:
        model = SessionApprentissage
        fields = '__all__'
// END OF FILE: module_interface/serializers.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/tests.py

from django.test import TestCase

# Create your tests here.
// END OF FILE: module_interface/tests.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/urls.py

from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import SessionApprentissageViewSet, InteractionViewSet

router = DefaultRouter()
router.register(r'sessions', SessionApprentissageViewSet)
router.register(r'interactions', InteractionViewSet)

urlpatterns = [
    path('', include(router.urls)),
]
// END OF FILE: module_interface/urls.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_interface/views.py

from rest_framework import viewsets
from drf_spectacular.utils import extend_schema
from .models import SessionApprentissage, Interaction
from .serializers import SessionApprentissageSerializer, InteractionSerializer

@extend_schema(tags=['Interface - Sessions'])
class SessionApprentissageViewSet(viewsets.ModelViewSet):
    queryset = SessionApprentissage.objects.all()
    serializer_class = SessionApprentissageSerializer

@extend_schema(tags=['Interface - Interactions'])
class InteractionViewSet(viewsets.ModelViewSet):
    queryset = Interaction.objects.all()
    serializer_class = InteractionSerializer
// END OF FILE: module_interface/views.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/admin.py

from django.contrib import admin

# Register your models here.
// END OF FILE: module_tuteur/admin.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/agent.py

import json
import asyncio
from asgiref.sync import sync_to_async
from google.adk.runners import Runner
from google.genai.types import Content, Part
from google.adk.sessions import DatabaseSessionService

# AJOUT DES IMPORTS POUR LA SAUVEGARDE ADK (Event, EventActions)
from google.adk.events import Event, EventActions

# Imports internes des mod√®les et agents Django
from config.adk_session import db_url # On importe uniquement l'URL de la base de donn√©es
from module_expert.agent import expert_app # L'application ADK de l'expert
from module_expert.models import CasClinique, DomaineMedical
from module_apprenant.models import Apprenant, ProfilEtudiant, NiveauCompetence
from module_interface.models import SessionApprentissage, Interaction
from .strategies import StrategieSocratique, StrategieDirecte, StrategieScaffolding

class TuteurIA:
    """
    Orchestrateur principal du syst√®me de Tuteur Intelligent (STI).
    G√®re le d√©roulement de la session d'apprentissage, interagit avec l'Agent Expert,
    met √† jour le profil de l'apprenant et adapte la strat√©gie p√©dagogique.
    """
    
    def __init__(self):
        self.strategies = {
            'SOCRATIQUE': StrategieSocratique(),
            'DIRECT': StrategieDirecte(),
            'SCAFFOLDING': StrategieScaffolding()
        }

    # --- M√âTHODE CRUCIALE POUR G√âRER LE SERVICE DE SESSION ADK ---
    async def _get_session_service(self):
        """
        Cr√©e une nouvelle instance du DatabaseSessionService de l'ADK pour la requ√™te courante.
        Ceci est essentiel pour √©viter les conflits de boucles d'√©v√©nements
        lorsque l'application Django (asynchrone) interagit avec SQLAlchemy/asyncpg.
        """
        # On importe DatabaseSessionService ici pour s'assurer qu'il est cr√©√© dans le bon contexte
        from google.adk.sessions import DatabaseSessionService
        return DatabaseSessionService(db_url=db_url)

    async def demarrer_session_async(self, apprenant_email: str, domaine_nom: str):
        """
        D√©marre une nouvelle session d'apprentissage pour un apprenant et un domaine donn√©s.
        Initialise √† la fois la session Django et la session ADK associ√©e.
        """
        try:
            # 1. R√©cup√©ration des objets Django (Apprenant, Domaine, Cas Clinique)
            apprenant = await Apprenant.objects.aget(email=apprenant_email)
            domaine = await DomaineMedical.objects.aget(nom__iexact=domaine_nom)
            
            # S√©lection d'un cas clinique pertinent (logique simple ici, pourrait √™tre plus complexe)
            cas = await CasClinique.objects.filter(
                domaine=domaine, 
                statut=CasClinique.StatutCas.PUBLIE
            ).afirst()
            
            if not cas:
                return None, f"Aucun cas clinique 'PUBLIE' disponible pour le domaine '{domaine_nom}'."

            # Cr√©ation de la session Django (persistance de l'historique m√©tier)
            session_django = await SessionApprentissage.objects.acreate(
                apprenant=apprenant,
                cas_clinique=cas
            )

            # 2. Cr√©ation de la session ADK (persistance de l'√©tat de l'agent)
            # Le service est cr√©√© localement pour cette requ√™te
            adk_session_service = await self._get_session_service()

            await adk_session_service.create_session(
                app_name=expert_app.name, # Nom de l'application ADK de l'expert
                user_id=str(apprenant.id),
                session_id=str(session_django.id), # Lier la session ADK √† la session Django
                state={
                    # √âtat initial pour le "scratchpad" de l'agent ADK
                    "etape_courante": "Anamn√®se",
                    "erreurs_consecutives": 0,
                    "cas_context": cas.donnees_patient # Charger le contexte du cas clinique
                }
            )

            return session_django, f"Session d√©marr√©e sur le cas : {cas.titre}"

        except Apprenant.DoesNotExist:
            return None, f"Apprenant avec l'email '{apprenant_email}' non trouv√©."
        except DomaineMedical.DoesNotExist:
            return None, f"Domaine m√©dical '{domaine_nom}' non trouv√©."
        except Exception as e:
            # En cas d'erreur inattendue, afficher la trace compl√®te pour le d√©bogage
            import traceback
            traceback.print_exc()
            return None, f"Erreur lors du d√©marrage de la session: {str(e)}"

    async def analyser_reponse_async(self, session_id: str, reponse_etudiant: str, etape_actuelle: str):
        """
        Analyse la r√©ponse de l'apprenant, consulte l'expert IA, met √† jour le profil,
        et g√©n√®re un feedback p√©dagogique.
        """
        try:
            # 1. R√©cup√©rer la session Django et les objets li√©s avec `select_related`
            # Ceci permet d'√©viter les requ√™tes synchrones bloquantes sur les Foreign Keys
            session_django = await SessionApprentissage.objects.select_related(
                'cas_clinique__domaine', # Charge le cas clinique et son domaine associ√©
                'apprenant'              # Charge l'apprenant associ√©
            ).aget(id=session_id)
            
            # Acc√®s direct aux objets d√©j√† charg√©s
            cas = session_django.cas_clinique
            apprenant = session_django.apprenant
            domaine = cas.domaine  
            
            # R√©cup√©rer le profil de l'apprenant pour la mise √† jour XP/comp√©tences
            profil = await ProfilEtudiant.objects.aget(apprenant=apprenant)

            # 2. Pr√©parer le Runner ADK avec un service de session LOCAL
            adk_session_service = await self._get_session_service()

            runner = Runner(
                agent=expert_app.root_agent,
                app_name=expert_app.name,
                session_service=adk_session_service # Utiliser l'instance locale du service
            )

            # 3. Construire le prompt pour l'Agent Expert
            # On demande un format JSON sp√©cifique pour faciliter le parsing
            prompt_content = (
                f"CONTEXTE DU CAS: '{cas.titre}'.\n"
                f"DONN√âES PATIENT: {cas.donnees_patient}.\n"
                f"HISTORIQUE M√âDICAL: {cas.historique_medical}.\n"
                f"SOLUTION EXPERTE ATTENDUE: '{cas.solution_experte}'.\n"
                f"L'√âTUDIANT PROPOSE (√©tape '{etape_actuelle}'): '{reponse_etudiant}'.\n\n"
                "TACHE: √âvalue la r√©ponse de l'√©tudiant. Est-elle correcte m√©dicalement par rapport √† la solution experte ?\n"
                "Si non, quelles sont les erreurs principales d√©tect√©es ?\n"
                "FORMAT DE SORTIE ATTENDU (JSON uniquement): "
                "{ \"correct\": boolean, \"raison\": \"string\", \"erreurs_detectees\": [\"string\"] }"
            )
            
            user_message = Content(parts=[Part(text=prompt_content)])

            # 4. Ex√©cuter l'Agent Expert via le Runner ADK
            expert_response_text = ""
            async for event in runner.run_async(
                user_id=str(apprenant.id),
                session_id=str(session_id),
                new_message=user_message
            ):
                if event.is_final_response() and event.content:
                    expert_response_text = event.content.parts[0].text

            # 5. Parsing de la r√©ponse JSON de l'Expert
            try:
                # Nettoyage pour retirer les blocs de code Markdown (```json...```)
                clean_json = expert_response_text.replace('```json', '').replace('```', '').strip()
                resultat_expert = json.loads(clean_json)
                est_correct = resultat_expert.get('correct', False)
                raison_expert = resultat_expert.get('raison', 'Analyse non disponible.')
                erreurs_expert = resultat_expert.get('erreurs_detectees', [])
            except json.JSONDecodeError:
                # Fallback si l'IA ne r√©pond pas en JSON valide
                est_correct = False
                raison_expert = "L'expert n'a pas pu √©valuer la r√©ponse (format invalide)."
                erreurs_expert = [expert_response_text] # Mettre la r√©ponse brute comme erreur
            except Exception as e:
                est_correct = False
                raison_expert = f"Erreur interne lors du traitement de la r√©ponse de l'expert: {str(e)}"
                erreurs_expert = []

            # 6. Mise √† jour de l'√©tat de la session ADK (persistance des erreurs cons√©cutives)
            # R√©cup√©rer l'√©tat actuel de la session ADK
            session_adk = await adk_session_service.get_session(
                app_name=expert_app.name, 
                user_id=str(apprenant.id), 
                session_id=str(session_id)
            )
            
            current_errors = session_adk.state.get("erreurs_consecutives", 0)
            
            if not est_correct:
                new_errors = current_errors + 1
            else:
                new_errors = 0 # R√©initialiser les erreurs si la r√©ponse est correcte

            # Cr√©er un √©v√©nement ADK pour persister la mise √† jour de l'√©tat dans la base de donn√©es
            state_update_event = Event(
                author="system", # L'auteur de cet √©v√©nement est le syst√®me de tutorat
                actions=EventActions(state_delta={"erreurs_consecutives": new_errors})
            )
            await adk_session_service.append_event(session_adk, state_update_event)

            # 7. Mise √† jour du profil de l'apprenant dans Django (XP, Comp√©tences, Lacunes)
            await self._update_competence_django(profil, domaine, est_correct, erreurs_expert) 
            
            # 8. Choix de la strat√©gie p√©dagogique en fonction du r√©sultat et des erreurs pass√©es
            strategie = self._choisir_strategie(est_correct, new_errors)
            
            if est_correct:
                feedback = f"Bien jou√© ! {raison_expert}"
            else:
                # Utilise la strat√©gie choisie pour g√©n√©rer un indice
                feedback = strategie.generer_indice(cas.donnees_patient, etape_actuelle)

            # 9. Enregistrement de l'interaction dans la base de donn√©es Django
            await Interaction.objects.acreate(
                session=session_django,
                question_contenu=f"√âtape: {etape_actuelle}",
                reponse_contenu=reponse_etudiant,
                reponse_est_valide=est_correct,
                feedback_contenu=feedback,
                feedback_type=strategie.style_feedback()
            )

            # Retourner le r√©sultat √† l'interface utilisateur
            return {
                "valide": est_correct,
                "feedback": feedback,
                "expert_raw": raison_expert
            }

        except SessionApprentissage.DoesNotExist:
            return {"error": f"Session Django avec l'ID '{session_id}' introuvable."}
        except Exception as e:
            import traceback
            traceback.print_exc()
            return {"error": f"Erreur interne du tuteur: {str(e)}"}

    @sync_to_async
    def _update_competence_django(self, profil: ProfilEtudiant, domaine: DomaineMedical, est_correct: bool, erreurs_expert: list):
        """
        Met √† jour les scores de comp√©tences (NiveauCompetence) et le profil global (ProfilEtudiant)
        de l'apprenant. Cette fonction s'ex√©cute de mani√®re synchrone.
        """
        # Mise √† jour du NiveauCompetence pour le domaine sp√©cifique
        comp, _ = NiveauCompetence.objects.get_or_create(
            profil_etudiant=profil,
            domaine=domaine,
            defaults={'niveau_actuel': 'DEBUTANT', 'score_diagnostic': 0.0, 'score_raisonnement': 0.0}
        )
        
        if est_correct:
            comp.score_diagnostic += 5
        else:
            comp.score_diagnostic = max(0, comp.score_diagnostic - 2) # Emp√™che le score de devenir n√©gatif
        
        # Logique simplifi√©e de progression de niveau
        if comp.score_diagnostic > 80:
            comp.niveau_actuel = 'EXPERT'
        elif comp.score_diagnostic > 50:
            comp.niveau_actuel = 'AVANCE'
        elif comp.score_diagnostic > 20:
            comp.niveau_actuel = 'INTERMEDIAIRE'
        else:
            comp.niveau_actuel = 'DEBUTANT'
             
        comp.save()

        # Mise √† jour du ProfilEtudiant (XP total et lacunes)
        if est_correct:
            profil.xp_total += 10 # Gagner plus d'XP pour une bonne r√©ponse
        
        # Enregistrer les lacunes si la r√©ponse est incorrecte et que l'expert a identifi√© des erreurs
        if not est_correct and erreurs_expert:
            current_lacunes_list = json.loads(profil.lacunes_identifiees or "[]")
            for erreur in erreurs_expert:
                if erreur not in current_lacunes_list: # √âvite les doublons
                    current_lacunes_list.append(erreur)
            profil.lacunes_identifiees = json.dumps(current_lacunes_list)
        elif est_correct:
            # Si l'apprenant r√©ussit, on peut envisager de "r√©soudre" des lacunes
            # Pour l'instant, on ne fait rien de sophistiqu√© ici, les lacunes persistent jusqu'√† une gestion explicite
            pass 

        profil.save() # Sauvegarde toutes les modifications du profil

    def _choisir_strategie(self, est_correct: bool, nb_erreurs_consecutives: int):
        """
        Choisit la strat√©gie p√©dagogique (Socratique, Directe, Scaffolding)
        en fonction du r√©sultat de la derni√®re r√©ponse et du nombre d'erreurs cons√©cutives.
        """
        if est_correct:
            return self.strategies['SOCRATIQUE'] # Si correct, on encourage √† la r√©flexion
        
        # Si plusieurs erreurs, on devient plus directif
        if nb_erreurs_consecutives >= 2:
            return self.strategies['DIRECT'] 
        else:
            return self.strategies['SCAFFOLDING'] # Aide progressive

# Instance unique du TuteurIA, car elle est stateless (l'√©tat est dans ADK Session et Django DB)
tuteur_service = TuteurIA()// END OF FILE: module_tuteur/agent.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/apps.py

from django.apps import AppConfig


class ModuleTuteurConfig(AppConfig):
    name = 'module_tuteur'
// END OF FILE: module_tuteur/apps.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/constante.py

# module_tuteur/constante.py
MODEL_NAME = "NomDuModeleUtilise"  # Remplacez par le nom r√©el du mod√®le
// END OF FILE: module_tuteur/constante.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/__init__.py

// END OF FILE: module_tuteur/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/migrations/__init__.py

// END OF FILE: module_tuteur/migrations/__init__.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/models.py

from django.db import models

# Create your models here.
// END OF FILE: module_tuteur/models.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/serializers.py

from rest_framework import serializers

class DemarrerSessionSerializer(serializers.Serializer):
    email_apprenant = serializers.EmailField()
    domaine_nom = serializers.CharField()

class AnalyseReponseSerializer(serializers.Serializer):
    session_id = serializers.UUIDField()
    reponse_etudiant = serializers.CharField()
    etape_actuelle = serializers.CharField(required=False, default="Diagnostic")// END OF FILE: module_tuteur/serializers.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/services.py

// END OF FILE: module_tuteur/services.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/strategies.py

from abc import ABC, abstractmethod
import random

class StrategieApprentissage(ABC):
    """
    Interface pour les strat√©gies d'apprentissage du Tuteur Intelligent.
    """
    
    @abstractmethod
    def generer_indice(self, contexte_clinique, etape_actuelle):
        """G√©n√®re un indice adapt√© √† la strat√©gie."""
        pass

    @abstractmethod
    def choisir_prochaine_question(self, etape_actuelle):
        """Choisit la prochaine question √† poser."""
        pass

    @abstractmethod
    def style_feedback(self):
        """Retourne le type de feedback (DIRECT, SOCRATIQUE, SCAFFOLDING)."""
        pass

class StrategieSocratique(StrategieApprentissage):
    """
    Strat√©gie qui pose des questions pour guider l'√©tudiant vers la r√©ponse
    sans la donner directement.
    """
    def generer_indice(self, contexte_clinique, etape_actuelle):
        questions_indices = [
            "Quels √©l√©ments du dossier patient contredisent ton hypoth√®se ?",
            "Si tu regardes attentivement les constantes vitales, que remarques-tu ?",
            "Quel lien fais-tu entre ce sympt√¥me et tes connaissances th√©oriques ?"
        ]
        return random.choice(questions_indices)

    def choisir_prochaine_question(self, etape_actuelle):
        return f"Pourquoi penses-tu que l'√©tape '{etape_actuelle}' est pertinente ici ?"

    def style_feedback(self):
        return "SOCRATIQUE"

class StrategieDirecte(StrategieApprentissage):
    """
    Strat√©gie qui donne des feedbacks clairs et correctifs imm√©diats.
    """
    def generer_indice(self, contexte_clinique, etape_actuelle):
        return f"Pour l'√©tape '{etape_actuelle}', concentre-toi sur les donn√©es : {list(contexte_clinique.keys())[:2]}."

    def choisir_prochaine_question(self, etape_actuelle):
        return f"Quel est le r√©sultat attendu pour : {etape_actuelle} ?"

    def style_feedback(self):
        return "DIRECT"

class StrategieScaffolding(StrategieApprentissage):
    """
    Strat√©gie d'√©tayage : fournit beaucoup d'aide au d√©but et r√©duit progressivement.
    """
    def generer_indice(self, contexte_clinique, etape_actuelle):
        return f"Rappel : Dans ce type de cas, on commence g√©n√©ralement par v√©rifier {etape_actuelle}. Regarde la valeur..."

    def choisir_prochaine_question(self, etape_actuelle):
        return f"Commen√ßons ensemble. Quelle est la premi√®re chose √† v√©rifier pour {etape_actuelle} ?"

    def style_feedback(self):
        return "SCAFFOLDING"
// END OF FILE: module_tuteur/strategies.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/tests.py

from django.test import TestCase

# Create your tests here.
// END OF FILE: module_tuteur/tests.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/urls.py

from django.urls import path
from .views import TuteurViewSet

# On mappe manuellement les m√©thodes du ViewSet aux URLs
urlpatterns = [
    # Route pour d√©marrer la session (POST)
    path(
        'session/start/', 
        TuteurViewSet.as_view({'post': 'create_session'}), 
        name='tuteur-start-session'
    ),
    
    # Route pour envoyer une r√©ponse et obtenir un feedback (POST)
    path(
        'session/analyser/', 
        TuteurViewSet.as_view({'post': 'analyser_reponse'}), 
        name='tuteur-analyser-reponse'
    ),
]// END OF FILE: module_tuteur/urls.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/module_tuteur/views.py

from rest_framework import status
from rest_framework.response import Response
from drf_spectacular.utils import extend_schema
from adrf.viewsets import ViewSet # Indispensable pour l'async natif

from .agent import tuteur_service
from .serializers import AnalyseReponseSerializer, DemarrerSessionSerializer

class TuteurViewSet(ViewSet):
    """
    ViewSet 100% Asynchrone.
    """
    
    @extend_schema(request=DemarrerSessionSerializer)
    async def create_session(self, request):
        serializer = DemarrerSessionSerializer(data=request.data)
        if serializer.is_valid():
            # Appel direct avec await, sans wrapper
            session, msg = await tuteur_service.demarrer_session_async(
                serializer.validated_data['email_apprenant'],
                serializer.validated_data['domaine_nom']
            )
            
            if session:
                return Response({
                    "session_id": session.id,
                    "message": msg
                }, status=status.HTTP_201_CREATED)
            return Response({"error": msg}, status=status.HTTP_400_BAD_REQUEST)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    @extend_schema(request=AnalyseReponseSerializer)
    async def analyser_reponse(self, request):
        serializer = AnalyseReponseSerializer(data=request.data)
        if serializer.is_valid():
            # Appel direct avec await
            result = await tuteur_service.analyser_reponse_async(
                serializer.validated_data['session_id'],
                serializer.validated_data['reponse_etudiant'],
                serializer.validated_data.get('etape_actuelle', 'Diagnostic')
            )
            
            if "error" in result:
                 return Response(result, status=status.HTTP_400_BAD_REQUEST)
                 
            return Response(result)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)// END OF FILE: module_tuteur/views.py

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/requirements.txt

Django>=4.2,<5.0
psycopg2-binary
djangorestframework
drf-spectacular
gunicorn
sqlalchemy
google-adk
python-dotenv
adrf
asyncpg// END OF FILE: requirements.txt

//---> PATH: /home/mbogneng-junior/Documents/5GI/Projets/STI/backend/wait_for_db.py

import time
import psycopg2
from psycopg2 import OperationalError

while True:
    try:
        conn = psycopg2.connect(
            dbname="backendsti",
            user="backendsti",
            password="backendsti",
            host="db",
            port="5432"
        )
        conn.close()
        break
    except OperationalError:
        print("Waiting for database...")
        time.sleep(1)
// END OF FILE: wait_for_db.py

